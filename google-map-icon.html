<!-- Copyright (c) 2015 Google Inc. All rights reserved. -->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="marker-behavior.html">

<!--
The `google-map-icon` element represents a map marker. It is used as a
child of `google-map`. This element just support iron-icons.

<b>Example</b>:

<google-map latitude="37.77493" longitude="-122.41942">
<google-map-icon latitude="37.779" longitude="-122.3892"
title="Go Giants!"
icon="icons:home"
icon-scale="1"
icon-fill-color="yellow"></google-map-icon>
</google-map>

<b>Example</b> - marker with info window (children create the window content):

<google-map-icon latitude="37.77493" longitude="-122.41942" icon="icons:home">
<img src="image.png">
</google-map-icon>

<b>Example</b> - a draggable marker:

<google-map-icon latitude="37.77493" longitude="-122.41942" icon="icons:home"
draggable="true"></google-map-icon>

<b>Example</b> - hide a marker:

<google-map-icon latitude="37.77493" longitude="-122.41942" icon="icons:home"
hidden></google-map-icon>

-->

<dom-module id="google-map-icon">
<style>
:host {
  display: none;
}
</style>
<template><content></content></template>
</dom-module>

<script>
Polymer({
  is: 'google-map-icon',

  properties: {
    /**
    * Name of the SVG icon to be used in iron-icon see .
    * @type string|google.maps.Icon|google.maps.Symbol
    */
    icon: {
      type: Object,
      value: null
    },

    /**
    * Fill color for the marker icon (only for iron-icon).
    * @type string
    */
    iconFillColor: {
      type: String,
      value: null
    },

    /**
    * Sroke color for the marker icon (only for iron-icon).
    * @type string
    */
    iconStrokeColor: {
      type: String,
      value: null
    },

    /**
    * Icon scale (only for iron-icon).
    * @type number
    */
    iconScale: {
      type: Number,
      value: 1
    }
  },

  behaviors: [GoogleMapBehaviors.MarkerBehavior],

  observers: [
    '_iconChanged(icon, iconFillColor, iconStrokeColor, iconScale)'
  ],

  _iconChanged: function() {
    if (this.marker) {
      this.marker.setIcon(this._getIcon(
        this.icon,
        this.iconFillColor,
        this.iconStrokeColor,
        this.iconScale
      ));
    }
  },

  _getIcon: function(icon, fillColor, strokeColor, scale) {
    if(!this._isUrl(icon)) {
      // Is a iron-icon, so loading icon
      var el = document.createElement('iron-icon');
      el.style.visibility = 'hidden';
      el.style.display = 'block';
      el.set('icon', this.icon);

      // Load SVG path
      var path = el.$$('path');
      if(!path || path.length < 1) {
        throw Error('Error loading svg path from iron-icon');
      }
      this.appendChild(el);
      var defFillColor = window.getComputedStyle(el).getPropertyValue('fill');
      var defStrokeColor = window.getComputedStyle(el).getPropertyValue('stroke');
      var icon = {
        path: path.getAttribute('d'),
        fillColor: fillColor || defFillColor,
        strokeColor: strokeColor || defStrokeColor,
        anchor: this._getIconAnchor(el, scale),
        scale: scale
      };
      if(fillColor) icon.fillOpacity = 1;
      if(strokeColor) icon.strokeOpacity = 1;

      this.removeChild(el);
      return icon;
    }
    return icon;
  },

  _getIconAnchor: function(el, scale) {
    // The correct way to do this is to wait for the element rendering and
    // get the width in pixels of the rendered element, the code below
    // works but only for pixel values
    var width = window.getComputedStyle(el).width;
    var height = window.getComputedStyle(el).height;

    var x = (Math.round(Number(width.replace(/\D+/g, '')) * scale) / (2 * scale)); // Set middle
    var y = (Math.round(Number(height.replace(/\D+/g, '')) * scale) / (2 * scale)); // Set middle
    return new google.maps.Point(x,y);
  },

  _mapReady: function() {
    this._listeners = {};
    this.marker = new google.maps.Marker({
      map: this.map,
      position: {
        lat: parseFloat(this.latitude),
        lng: parseFloat(this.longitude)
      },
      title: this.title,
      animation: google.maps.Animation[this.animation],
      draggable: this.draggable,
      visible: !this.hidden,
      icon: this._getIcon(this.icon, this.iconFillColor, this.iconStrokeColor, this.iconScale),
      zIndex: this.zIndex
    });
    this._contentChanged();
    this._clickEventsChanged();
    this._dragEventsChanged();
    this._mouseEventsChanged();
    this._openChanged();
    setupDragHandler_.bind(this)();
  },

  _isUrl: function(str) {
    var pattern = new RegExp('^(https?:\\/\\/)?'+ // protocol
    '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.?)+[a-z]{2,}|'+ // domain name
    '((\\d{1,3}\\.){3}\\d{1,3}))'+ // OR ip (v4) address
    '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*'+ // port and path
    '(\\?[;&a-z\\d%_.~+=-]*)?'+ // query string
    '(\\#[-a-z\\d_]*)?$','i'); // fragment locator
    return pattern.test(str);
  }
});
</script>
